{
    "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
    "name": "rsx",
    "scopeName": "source.rsx",
    "patterns": [
        {
            "include": "#rust-section"
        },
        {
            "include": "#script-section"
        },
        {
            "include": "#template-section"
        },
        {
            "include": "#style-section"
        }
    ],
    "repository": {
        "rust-section": {
            "begin": "^---\\s*$",
            "end": "^---\\s*$",
            "name": "meta.embedded.block.rust",
            "contentName": "source.rust.embedded.rsx",
            "patterns": [
                {
                    "include": "source.rust"
                }
            ]
        },
        "script-section": {
            "begin": "<script(?:\\s[^>]*)?>",
            "end": "</script>",
            "name": "meta.embedded.block.typescript",
            "contentName": "source.ts.embedded.rsx",
            "patterns": [
                {
                    "include": "source.ts"
                }
            ]
        },
        "template-section": {
            "begin": "<template(?:\\s[^>]*)?>",
            "end": "</template>",
            "name": "meta.embedded.block.handlebars",
            "contentName": "text.html.handlebars.embedded.rsx",
            "patterns": [
                {
                    "include": "#handlebars-template"
                }
            ]
        },
        "style-section": {
            "begin": "<style(?:\\s+lang=[\"']scss[\"']|\\s[^>]*)?>",
            "end": "</style>",
            "name": "meta.embedded.block.scss",
            "contentName": "source.scss.embedded.rsx",
            "patterns": [
                {
                    "include": "source.scss"
                }
            ]
        },
        "handlebars-template": {
            "patterns": [
                {
                    "include": "#handlebars-block"
                },
                {
                    "include": "#handlebars-expression"
                },
                {
                    "include": "#html-tag-restricted"
                },
                {
                    "include": "text.html.basic"
                }
            ]
        },
        "handlebars-block": {
            "patterns": [
                {
                    "begin": "\\{#(if|each|unless|with)\\b",
                    "end": "\\{/(if|each|unless|with)\\}",
                    "name": "meta.block.handlebars",
                    "beginCaptures": {
                        "0": {
                            "name": "keyword.control.handlebars"
                        }
                    },
                    "endCaptures": {
                        "0": {
                            "name": "keyword.control.handlebars"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#handlebars-template"
                        }
                    ]
                },
                {
                    "match": "\\{:(else|else if)\\}",
                    "name": "keyword.control.handlebars"
                }
            ]
        },
        "handlebars-expression": {
            "patterns": [
                {
                    "begin": "\\{\\{",
                    "end": "\\}\\}",
                    "name": "meta.expression.handlebars",
                    "patterns": [
                        {
                            "match": "@html\\b",
                            "name": "keyword.other.handlebars"
                        },
                        {
                            "match": "\\b\\w+\\b",
                            "name": "variable.other.handlebars"
                        }
                    ]
                }
            ]
        },
        "html-tag-restricted": {
            "patterns": [
                {
                    "begin": "<(script|style|template)\\b",
                    "end": ">",
                    "name": "invalid.illegal.tag.template.rsx",
                    "captures": {
                        "1": {
                            "name": "invalid.illegal.tag-name.template.rsx"
                        }
                    }
                },
                {
                    "begin": "<([a-zA-Z][a-zA-Z0-9-]*)\\b",
                    "end": "/?>",
                    "name": "meta.tag.html",
                    "beginCaptures": {
                        "1": {
                            "name": "entity.name.tag.html"
                        }
                    },
                    "patterns": [
                        {
                            "match": "\\b(on[a-zA-Z]+)\\s*=",
                            "captures": {
                                "1": {
                                    "name": "invalid.illegal.attribute.event.template.rsx"
                                }
                            }
                        },
                        {
                            "match": "\\b([a-zA-Z-]+)\\s*=\\s*([\"'][^\"']*[\"'])",
                            "captures": {
                                "1": {
                                    "name": "entity.other.attribute-name.html"
                                },
                                "2": {
                                    "name": "string.quoted.html"
                                }
                            }
                        },
                        {
                            "match": "\\b[a-zA-Z-]+\\b",
                            "name": "entity.other.attribute-name.html"
                        }
                    ]
                }
            ]
        }
    }
}
            ]
        },
        {
            "comment": "Template标签 - Handlebars模板",
            "begin": "(<)(template)(?![^/>]*/>\\s*$)",
            "beginCaptures": {
                "1": {
                    "name": "punctuation.definition.tag.begin.html"
                },
                "2": {
                    "name": "entity.name.tag.template.html"
                }
            },
            "end": "(</)(template)(>)",
            "endCaptures": {
                "1": {
                    "name": "punctuation.definition.tag.begin.html"
                },
                "2": {
                    "name": "entity.name.tag.template.html"
                },
                "3": {
                    "name": "punctuation.definition.tag.end.html"
                }
            },
            "patterns": [
                {
                    "begin": "(>)",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.tag.end.html"
                        }
                    },
                    "end": "(?=</template>)",
                    "contentName": "text.html.handlebars.embedded.rsx",
                    "patterns": [
                        {
                            "include": "#handlebars-template"
                        }
                    ]
                }
            ]
        },
        {
            "comment": "Style标签 - SCSS样式",
            "begin": "(<)(style)(?![^/>]*/>\\s*$)",
            "beginCaptures": {
                "1": {
                    "name": "punctuation.definition.tag.begin.html"
                },
                "2": {
                    "name": "entity.name.tag.style.html"
                }
            },
            "end": "(</)(style)(>)",
            "endCaptures": {
                "1": {
                    "name": "punctuation.definition.tag.begin.html"
                },
                "2": {
                    "name": "entity.name.tag.style.html"
                },
                "3": {
                    "name": "punctuation.definition.tag.end.html"
                }
            },
            "patterns": [
                {
                    "begin": "(>)",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.tag.end.html"
                        }
                    },
                    "end": "(?=</style>)",
                    "contentName": "source.scss.embedded.rsx",
                    "patterns": [
                        {
                            "include": "source.scss"
                        }
                    ]
                }
            ]
        }
    ],
    "repository": {
        "handlebars-template": {
            "patterns": [
                {
                    "include": "#handlebars-comments"
                },
                {
                    "include": "#handlebars-block-helpers"
                },
                {
                    "include": "#handlebars-variables"
                },
                {
                    "include": "#handlebars-raw-html"
                },
                {
                    "include": "#html-tags"
                },
                {
                    "include": "text.html.basic"
                }
            ]
        },
        "handlebars-comments": {
            "patterns": [
                {
                    "name": "comment.block.handlebars.rsx",
                    "begin": "\\{\\{!--",
                    "end": "--\\}\\}",
                    "patterns": [
                        {
                            "name": "keyword.annotation.handlebars",
                            "match": "@\\w*"
                        }
                    ]
                },
                {
                    "name": "comment.block.handlebars.rsx",
                    "begin": "\\{\\{!",
                    "end": "\\}\\}",
                    "patterns": [
                        {
                            "name": "keyword.annotation.handlebars",
                            "match": "@\\w*"
                        }
                    ]
                }
            ]
        },
        "handlebars-block-helpers": {
            "patterns": [
                {
                    "comment": "条件渲染 - if/else",
                    "name": "meta.block.if.handlebars.rsx",
                    "begin": "(\\{\\{)(#if)\\s+([^}]+)(\\}\\})",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.block.begin.handlebars"
                        },
                        "2": {
                            "name": "keyword.control.conditional.handlebars"
                        },
                        "3": {
                            "name": "variable.other.handlebars"
                        },
                        "4": {
                            "name": "punctuation.definition.block.begin.handlebars"
                        }
                    },
                    "end": "(\\{\\{)(/if)(\\}\\})",
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.block.end.handlebars"
                        },
                        "2": {
                            "name": "keyword.control.conditional.handlebars"
                        },
                        "3": {
                            "name": "punctuation.definition.block.end.handlebars"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#handlebars-else"
                        },
                        {
                            "include": "#handlebars-template"
                        }
                    ]
                },
                {
                    "comment": "循环渲染 - each",
                    "name": "meta.block.each.handlebars.rsx",
                    "begin": "(\\{\\{)(#each)\\s+([^}]+)(\\}\\})",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.block.begin.handlebars"
                        },
                        "2": {
                            "name": "keyword.control.loop.handlebars"
                        },
                        "3": {
                            "name": "variable.other.handlebars"
                        },
                        "4": {
                            "name": "punctuation.definition.block.begin.handlebars"
                        }
                    },
                    "end": "(\\{\\{)(/each)(\\}\\})",
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.block.end.handlebars"
                        },
                        "2": {
                            "name": "keyword.control.loop.handlebars"
                        },
                        "3": {
                            "name": "punctuation.definition.block.end.handlebars"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#handlebars-template"
                        }
                    ]
                }
            ]
        },
        "handlebars-else": {
            "patterns": [
                {
                    "name": "meta.else.handlebars.rsx",
                    "match": "(\\{\\{)(:else\\s*if)\\s+([^}]+)(\\}\\})",
                    "captures": {
                        "1": {
                            "name": "punctuation.definition.block.handlebars"
                        },
                        "2": {
                            "name": "keyword.control.conditional.handlebars"
                        },
                        "3": {
                            "name": "variable.other.handlebars"
                        },
                        "4": {
                            "name": "punctuation.definition.block.handlebars"
                        }
                    }
                },
                {
                    "name": "meta.else.handlebars.rsx",
                    "match": "(\\{\\{)(:else)(\\}\\})",
                    "captures": {
                        "1": {
                            "name": "punctuation.definition.block.handlebars"
                        },
                        "2": {
                            "name": "keyword.control.conditional.handlebars"
                        },
                        "3": {
                            "name": "punctuation.definition.block.handlebars"
                        }
                    }
                }
            ]
        },
        "handlebars-variables": {
            "patterns": [
                {
                    "comment": "三重大括号变量 - 原始HTML",
                    "name": "meta.variable.triple.handlebars.rsx",
                    "match": "(\\{\\{\\{)([^}]+)(\\}\\}\\})",
                    "captures": {
                        "1": {
                            "name": "punctuation.definition.variable.begin.handlebars"
                        },
                        "2": {
                            "name": "variable.other.handlebars"
                        },
                        "3": {
                            "name": "punctuation.definition.variable.end.handlebars"
                        }
                    }
                },
                {
                    "comment": "双重大括号变量 - 转义HTML",
                    "name": "meta.variable.double.handlebars.rsx",
                    "match": "(\\{\\{)([^}]+)(\\}\\})",
                    "captures": {
                        "1": {
                            "name": "punctuation.definition.variable.begin.handlebars"
                        },
                        "2": {
                            "name": "variable.other.handlebars"
                        },
                        "3": {
                            "name": "punctuation.definition.variable.end.handlebars"
                        }
                    }
                }
            ]
        },
        "handlebars-raw-html": {
            "patterns": [
                {
                    "comment": "原始HTML输出",
                    "name": "meta.raw-html.handlebars.rsx",
                    "match": "(\\{\\{)(@html)\\s+([^}]+)(\\}\\})",
                    "captures": {
                        "1": {
                            "name": "punctuation.definition.variable.begin.handlebars"
                        },
                        "2": {
                            "name": "keyword.other.handlebars"
                        },
                        "3": {
                            "name": "variable.other.handlebars"
                        },
                        "4": {
                            "name": "punctuation.definition.variable.end.handlebars"
                        }
                    }
                }
            ]
        },
        "html-tags": {
            "patterns": [
                {
                    "comment": "客户端组件标签",
                    "name": "meta.tag.client-component.html",
                    "begin": "(<)([A-Z][a-zA-Z0-9]*)",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.tag.begin.html"
                        },
                        "2": {
                            "name": "entity.name.tag.component.html"
                        }
                    },
                    "end": "(/>|>)",
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.tag.end.html"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#client-attribute"
                        },
                        {
                            "include": "#html-attributes"
                        }
                    ]
                },
                {
                    "comment": "普通HTML标签",
                    "name": "meta.tag.html",
                    "begin": "(<)([a-z][a-zA-Z0-9]*)",
                    "beginCaptures": {
                        "1": {
                            "name": "punctuation.definition.tag.begin.html"
                        },
                        "2": {
                            "name": "entity.name.tag.html"
                        }
                    },
                    "end": "(/>|>)",
                    "endCaptures": {
                        "1": {
                            "name": "punctuation.definition.tag.end.html"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#html-attributes"
                        }
                    ]
                },
                {
                    "comment": "HTML结束标签",
                    "name": "meta.tag.html",
                    "match": "(</)([a-zA-Z0-9]+)(>)",
                    "captures": {
                        "1": {
                            "name": "punctuation.definition.tag.begin.html"
                        },
                        "2": {
                            "name": "entity.name.tag.html"
                        },
                        "3": {
                            "name": "punctuation.definition.tag.end.html"
                        }
                    }
                }
            ]
        },
        "client-attribute": {
            "patterns": [
                {
                    "comment": "client属性",
                    "name": "meta.attribute.client.html",
                    "match": "\\b(client)\\s*=\\s*([\"'])(react|vue|svelte)\\2",
                    "captures": {
                        "1": {
                            "name": "entity.other.attribute-name.html"
                        },
                        "3": {
                            "name": "string.quoted.html support.constant.client-type.rsx"
                        }
                    }
                }
            ]
        },
        "html-attributes": {
            "patterns": [
                {
                    "comment": "HTML属性",
                    "name": "meta.attribute.html",
                    "begin": "\\b([a-zA-Z0-9-]+)\\s*(=)\\s*",
                    "beginCaptures": {
                        "1": {
                            "name": "entity.other.attribute-name.html"
                        },
                        "2": {
                            "name": "punctuation.separator.key-value.html"
                        }
                    },
                    "end": "(?=[\\s>])",
                    "patterns": [
                        {
                            "include": "#attribute-values"
                        }
                    ]
                }
            ]
        },
        "attribute-values": {
            "patterns": [
                {
                    "comment": "带Handlebars变量的属性值",
                    "name": "string.quoted.double.html",
                    "begin": "\"",
                    "end": "\"",
                    "patterns": [
                        {
                            "include": "#handlebars-variables"
                        }
                    ]
                },
                {
                    "comment": "带Handlebars变量的属性值",
                    "name": "string.quoted.single.html",
                    "begin": "'",
                    "end": "'",
                    "patterns": [
                        {
                            "include": "#handlebars-variables"
                        }
                    ]
                }
            ]
        }
    }
}
